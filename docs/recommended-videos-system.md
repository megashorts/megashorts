# 추천 동영상 시스템 설계 문서

## 1. 개요
추천 동영상 페이지는 사용자에게 빠르고 끊김 없는 동영상 미리보기 경험을 제공하는 것을 목표로 합니다. 20MB 미만, 2분 이내의 세로형 짧은 동영상을 기반으로 하며, 사용자가 빠르게 스킵하며 둘러보는 사용 패턴에 최적화되어 있습니다.

## 2. 관리자 설정
### 2.1 핵심 설정 항목
1. 목록 크기 설정
   - 초기 로드 개수: 20개 (기본값)
   - 추가 로드 시점: 10번째 영상 (기본값)
   - 추가 로드 개수: 20개 (기본값)

2. 프리로딩 설정
   - 초기 세그먼트 길이: 3초 (기본값)
   - 프리로드 영상 수: 2개 (기본값)

### 2.2 설정 영향
- 초기 로드 개수가 크면:
  * 장점: 더 많은 컨텐츠 즉시 이용 가능
  * 단점: 초기 로딩 시간 증가
- 프리로드 영상 수가 크면:
  * 장점: 더 매끄러운 전환
  * 단점: 네트워크 사용량 증가

## 3. 동작 방식

### 3.1 초기 로딩
1. 목록 구성
   - 관리자 추천 영상 우선 (featured = true)
   - 우선순위 번호 낮은 순
   - 최신 등록 순
   ```typescript
   // 예시 쿼리
   const posts = await prisma.post.findMany({
     where: {
       status: 'PUBLISHED',
       NOT: { id: { in: watchedPostIds } }
     },
     orderBy: [
       { featured: 'desc' },
       { priority: 'asc' },
       { createdAt: 'desc' }
     ],
     take: initialLoadCount
   });
   ```

2. 시청 기록 처리
   - IndexedDB의 lastViews에서 시청 기록 확인
   - sequence > 1인 영상이 있는 포스트 제외
   - 모든 포스트 시청 시 처음부터 재시작
   - 페이지 접속마다 목록 새로 생성
   - localStorage로 마지막 시청 위치 복원

3. 시청 기록 저장
   - VideoPlayer에서 시청 기록 관리
   - 5초 도달 시 첫 저장
   - 이후 10초 단위로 업데이트
   - sequence > 1인 영상만 저장
   - 추천 페이지의 sequence=1 영상은 저장하지 않음

### 3.2 스트리밍 최적화
1. 현재 재생 영상
   - 전체 매니페스트 로드
   - 첫 3초 세그먼트 프리로드
   - 목적: 즉시 재생 시작

2. 다음 영상
   - 매니페스트만 미리 로드
   - 목적: 빠른 전환 준비

3. 그 이후 영상
   - 스트리밍 URL만 준비
   - 목적: 리소스 절약

### 3.3 추가 로딩 전략
1. 트리거 시점
   - 10번째 영상 도달 시
   - 목적: 충분한 여유를 두고 준비

2. 로딩 내용
   - 다음 20개 영상 메타데이터
   - 다음 2개 영상 매니페스트
   - 목적: 끊김 없는 경험 유지

## 4. 사용자 경험 최적화

### 4.1 빠른 초기 로딩
- 첫 화면 즉시 표시
- 첫 영상 3초 프리로드
- 나머지 데이터 백그라운드 로드

### 4.2 끊김 없는 전환
- 다음 영상 매니페스트 미리 준비
- 스와이프 시작 시 즉시 로드 시작
- 방향 예측 기반 프리로드

### 4.3 시청 기록 활용
- 브라우저 IndexedDB의 lastViews 사용
- sequence > 1인 영상 시청 기록 기반 필터링
- 이미 본 포스트 자동 제외
- 전체 시청 시 처음부터 재시작
- localStorage로 시청 위치 복원

### 4.4 성능 최적화
- lastViews 기반 빠른 필터링
- 불필요한 시청 기록 저장 방지
- 중복 API 호출 최소화
- 페이지 접속마다 새로운 목록 생성으로 메모리 관리
- 필요한 데이터만 저장하여 IndexedDB 최적화

### 4.5 데이터 관리
- 브라우저 IndexedDB:
  * watchedVideos: 시청한 동영상 ID 목록
  * lastViews: 포스트별 마지막 시청 정보
- localStorage:
  * 마지막 시청 위치 (recommendedViewIndex)
  * 음소거 상태
- 메모리:
  * 현재 로드된 포스트 목록
  * 활성화된 영상 인덱스

## 5. 에러 처리

### 5.1 네트워크 오류
- 매니페스트 로드 실패 시 재시도
- 세그먼트 로드 실패 시 다음 영상으로 전환
- 목록 로드 실패 시 기존 목록 유지

### 5.2 재생 오류
- 재생 시작 실패 시 다음 영상으로 자동 전환
- 버퍼링 발생 시 다음 영상 준비 시작
- 연속 오류 시 사용자 피드백 제공

## 6. 성능 모니터링

### 6.1 주요 지표
- 초기 로딩 시간
- 영상 전환 시간
- 버퍼링 발생 빈도
- 오류 발생 빈도

### 6.2 최적화 포인트
- 프리로드 타이밍 조정
- 목록 크기 최적화
- 캐싱 전략 개선

## 7. 향후 개선 사항
- 네트워크 상태에 따른 동적 최적화
- 사용자 패턴 기반 프리로드 조정
- 더 정교한 추천 알고리즘 적용
