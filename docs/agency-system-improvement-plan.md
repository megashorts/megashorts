# 에이전시 페이지 개선 요청 이해 및 정리

사용자님의 개선 요청을 분석하고 이해한 내용을 정리했습니다. 실제 구현 전에 제가 이해한 내용이 정확한지 확인해 주시기 바랍니다.

## 1. 공통 컴포넌트: 유저네임 검색 컴포넌트

- 어드민 페이지 전반에서 사용할 수 있는 유저네임 검색 및 선택 컴포넌트가 필요합니다.
- 이 컴포넌트는 유저네임이나 이메일로 사용자를 검색하고 선택할 수 있는 기능을 제공합니다.
- 관리자가 특정 사용자를 쉽게 찾을 수 있도록 도와줍니다.

## 2. 팀마스터 설정 탭 추가

- 에이전시 페이지에 새로운 "팀마스터 설정" 탭을 추가합니다.
- 이 탭은 유저롤 80(OPERATION3) 이상의 관리자만 볼 수 있으며, 그 이하 권한의 사용자에게는 탭 자체가 표시되지 않습니다.
- 주요 기능:
  - 유저네임이나 이메일 검색을 통해 모든 사용자를 검색하고 선택할 수 있음
  - 선택된 사용자의 유저롤 넘버를 팀마스터 권한(TEAM_MASTER, 50)으로 변경할 수 있음
  - 본부마스터 타입 설정 (본부구조 또는 네트워크)
  - 기본 수수료 비율 설정
  - 네트워크 타입 선택 시 "하위회원 수 제한" 설정 가능 (기본값: 2)
    - 이 옵션을 체크하면 자동으로 네트워크 바이너리 타입으로 설정됨
  - 설정 저장 시 위 내용만 저장됨

## 3. 설정 탭 수정

- 기존 설정 탭은 로그인한 사용자가 관리자로부터 지정받은 팀마스터 타입에 해당하는 설정만 표시합니다.
- 화면 상단에 사용자의 디스플레이네임, 유저롤 타입, 팀마스터 타입이 표시됩니다.
- 단계 설정:
  - 최상위 단계(팀마스터)와 최하위 단계(멤버)는 삭제할 수 없습니다.
  - "단계 추가" 버튼을 클릭하면 중간 단계만 추가됩니다.
  - 설정 저장 시 팀마스터를 제외한 모든 단계와 중간관리자 레벨별 수수료의 합이 99.9%를 초과할 수 없습니다.
- 본부구조 설정:
  - 단계별 수수료 입력 옆에 조회 아이콘 버튼 추가
  - 버튼 클릭 시 현재 레벨에 해당하는 자격자 목록을 모달로 표시
  - 모달에서 "+" 버튼을 통해 직접 추천인 관계가 아니더라도 자신의 하위 추천인 관계에 속한 사용자를 유저네임이나 이메일로 검색하여 추가 가능
- 타입 구분:
  - 실제 입력 항목은 본부구조와 네트워크 2가지로 단순화됩니다.
  - 데이터 구조상으로는 본부구조, 네트워크, 네트워크 바이너리 3가지로 유지됩니다.
  - 네트워크와 네트워크 바이너리는 회원가입에 따른 트리구조 제한만 다르므로, 입력 항목은 동일합니다.

## 4. 네트워크 타입의 중간관리자 설정 개선

- 팀마스터 타입이 네트워크일 경우에만 중간관리자 자동 자격 부여 설정이 표시됩니다.
- 기존과 달리 여러 개의 중간관리자 설정을 추가할 수 있습니다:
  - "중간관리자 추가" 버튼을 클릭하면 새로운 중간관리자 설정이 추가됩니다.
- 각 중간관리자 설정에는 다음 항목이 포함됩니다:
  - 활성화 버튼: 자동 자격 부여 기능 활성화/비활성화
  - 중간관리자 이름 입력 필드
  - 중간관리자에게 지급될 수수료 비율(%) 입력 필드
  - 조건 적용 방식: 3가지 항목(하위회원 수, 충전 금액, 사용 금액)에 대한 개별 체크박스
    - 1개, 2개, 또는 3개 모두 체크하여 조합 가능
  - "중간관리자 조회" 아이콘 버튼: 
    - 클릭 시 현재 중간관리자에 해당하는 자격자 목록을 모달로 표시
    - 모달에서 "+" 버튼을 통해 직접 추천인 관계가 아니더라도 자신의 하위 추천인 관계에 속한 사용자를 유저네임이나 이메일로 검색하여 추가 가능
  - 중간관리자 중복 처리 입력 항목:
    - 동일한 중간관리자 레벨이 여러 명 존재할 경우 수수료 분배 비율 설정
    - 예: "82,18"은 가장 가까운 상위 중간관리자에게 82%, 그 위의 동일 레벨 중간관리자에게 18% 지급
    - 예: "70,20,10"은 가까운 순서대로 3명에게 70%, 20%, 10% 지급
    - 비어있으면 가장 가까운 상위 중간관리자에게 전부 지급
    - 설정된 인원보다 실제 인원이 적을 경우, 남은 비율은 가장 가까운 사람에게 합산하여 지급

## 5. 본부구조 타입 시나리오 이해

1. 관리자가 팀마스터 설정 탭에서 1번 유저에게 본부구조 타입과 수수료 비율 10%를 설정
2. 1번 유저가 로그인하여 설정 탭에 접근하면:
   - 상단에 자신의 유저네임, 유저롤(팀마스터), 타입(본부구조), 수수료율(10%) 표시
   - 단계 및 수수료 설정 가능
   - 팀마스터는 자신이 설정한 단계 수수료를 제외한 나머지 수수료가 자동 표시됨
3. 추천인 구조 예시:
   - 2번 유저: 1번 유저를 추천인으로 가입, 1번 유저가 2번 유저를 대리점으로 설정
   - 3번 유저: 2번 유저를 추천인으로 가입, 2번 유저가 3번 유저를 멤버로 지정
   - 4번 유저: 3번 유저를 추천인으로 가입
4. 포인트 발생 시:
   - 4번 유저가 포인트 발생 행동을 하면, 1번 유저가 설정한 비율과 추천인 구조에 따라 포인트 지급
   - 3번 유저를 추천인으로 5번 유저가 가입한 경우, 3번 유저는 대리점과 멤버의 수수료를 합산하여 받음

## 6. 네트워크 타입 시나리오 이해

1. 관리자가 팀마스터 설정 탭에서 1번 유저에게 네트워크 타입과 수수료 비율 20%를 설정
2. 1번 유저가 로그인하여 설정 탭에 접근하면:
   - 상단에 자신의 유저네임, 유저롤(팀마스터), 타입(네트워크), 수수료율(20%) 표시
   - 단계 및 수수료 설정 가능
3. 설정 예시:
   - 팀마스터가 자신 외 3단계를 설정: 15%, 25%, 40%
   - 중간관리자 2개 설정: 중간관리자1(3%), 중간관리자2(7%)
   - 중간관리자2의 중복처리: "60,40" (2단계 중복처리)
   - 팀마스터 자신은 자동으로 10% 표시됨
4. 추천인 구조 예시:
   - 2번 유저: 1번 유저를 추천인으로 가입
   - 3번 유저: 2번 유저를 추천인으로 가입
   - 4번 유저: 3번 유저를 추천인으로 가입
   - 5번 유저: 4번 유저를 추천인으로 가입
5. 포인트 발생 시:
   - 5번 유저가 포인트 발생 행동을 하면, 상위 4명에게 설정된 비율에 따라 포인트 지급
   - 중간관리자가 있는 경우 추가 수수료 지급
6. 중간관리자 수수료 계산 예시:
   - 4번 유저를 추천인으로 6번 유저가 가입한 경우:
     - 상위 추천인이 3명만 존재
     - 4번 유저가 중간관리자가 아니면: 65% 받음
     - 4번 유저가 중간관리자2이면: 72% 받음
     - 4번 유저와 3번 유저 모두 중간관리자2이면: 4번 유저는 65% + (7% × 0.6) = 69.2% 받음
   - 중간관리자가 없는 경우: 중간관리자 지급 비율은 팀마스터에게 추가됨

## 7. 추가 고려사항 및 질문

1. **중간관리자 자격 부여 로직**:
   - 중간관리자 자격은 설정된 조건(하위회원 수, 충전 금액, 사용 금액)에 따라 자동으로 부여됩니다.
   - 조건 적용 방식이 개별 체크박스로 변경되어 더 유연한 조건 설정이 가능합니다.

2. **수수료 합계 제한**:
   - 팀마스터를 제외한 모든 단계와 중간관리자 레벨별 수수료의 합이 99.9%를 초과할 수 없습니다.
   - 이는 설정 저장 시 검증되어야 합니다.

3. **네트워크와 네트워크 바이너리 통합**:
   - 입력 UI 측면에서는 네트워크와 네트워크 바이너리가 통합되어, "하위회원 수 제한" 옵션으로 구분됩니다.
   - 데이터 구조상으로는 여전히 별도 타입으로 유지됩니다.

4. **중간관리자 중복 처리**:
   - 중간관리자 중복 처리는 동일 레벨의 중간관리자가 여러 명 존재할 때 수수료 분배 방식을 정의합니다.
   - 이는 쉼표로 구분된 비율 값으로 설정됩니다.

이상이 제가 이해한 개선 요청 사항입니다. 실제 구현 전에 이 내용이 정확한지 확인해 주시면, 요청하신 대로 수정을 진행하겠습니다.
